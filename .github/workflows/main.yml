name: Kmesh CI Workflow

on: pull_request

jobs:

  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        go-version: [ '1.21' ]
    
    env:
      GOPATH: /home/runner/go
      GOBIN: /home/runner/go/bin
      PKG_CONFIG_PATH: $GITHUB_WORKSPACE/mk

    steps:
    - uses: actions/checkout@v3

    - name: Setup Go
      uses: actions/setup-go@v4.0.0
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Build Kmesh
      shell: bash
      run: |
        sudo bash ./build.sh
    
    # Since requiring code generated by the Proto compilation, execute go lint after building.  
    - name: golangci-lint
      uses: golangci/golangci-lint-action@v3.7.0
      with:
        args: "--config=common/config/.golangci.yaml --out-format colored-line-number"
        skip-pkg-cache: true

    - name: Go Test
      run: |
        go test -v -vet=off ./...
